# LAB3 Report

石景宜 2016011395

## 练习1 给未被映射的地址映射上物理页

### 设计实现过程

根据提示，首先通过页目录基址和出错地址获得/创建对应页表项，若页表项对应页表不存在，则创建对应页。



#### 请描述页目录项（Page Directory Entry）和页表项（Page Table Entry）中组成部分对ucore实现页替换算法的潜在用处。

页目录项和页表项中对实现页替换算法有潜在用处的字段主要有：**访问位A**，**修改位D**，**存在位P**，其含义在LAB2中已经做过详细解释，不再赘述。

+ 访问位A主要可用于时钟替换算法和识别dirty bit的 extended clock页替换算法。
+ 修改位D，用于识别dirty bit的 extended clock页替换算法。
+ 存在位P，P为0,即当页面不存在于内存中时，其他位就可以用来存放任何所需要的信息，在本实验中用来存放了页的虚拟地址。



#### 如果ucore的缺页服务例程在执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？

在执行过程中访问内存出现页访问异常时，硬件首先要将出错地址保存在CR2寄存器中，然后查找IDT，跳转到中断服务例程中，CPU会在当前栈中压入CS/EIP和`error code`，由于已经在内核态中，不会发生特权级切换，最后会把控制权交给中断服务例程。



#### 参考答案对比

对比后发现，我没有考虑获取页表项和分配页出错的情况，已修复。



## 练习二 补充完成基于FIFO的页面替换算法（需要编程）

### 设计实现过程

按照提示，在`vmm.c`的函数`do_page_fault`函数中，添加页换入过程代码，调用函数换入对应页后，建立映射关系，设置页为可交换，最后设置页的虚地址变量。

在`swap_fifo.c`中，完成对应两个函数，直接按照注释完成即可。

+ 在`_fifo_map_swappable`中，将新页插入到页表队列最后，即`head`之前
+ 在`_fifo_swap_out_victim`中，将最后访问的页从链表中删去并把对应页赋值给`*ptr_page`

#### 如果要在ucore上实现"extended clock页替换算法"请给你的设计方案，现有的swap_manager框架是否足以支持在ucore中实现此算法？如果是，请给你的设计方案。如果不是，请给出你的新的扩展和基此扩展的设计方案。并需要回答如下问题

- 需要被换出的页的特征是什么？
- 在ucore中如何判断具有这样特征的页？
- 何时进行换入和换出操作？

##### 设计方案

现有框架可以实现此算法，设置一个全局页指针作为时钟指针，每次插入直接插入到head前即可，在换出时，需要进行判断访问位A，写入位D的取值对（A,D），进行不同的操作。

+ （0,0)，换出并让指针指向下一页。
+ （0,1)：写入交换分区并清零D位，指针指向下一页继续查找。
+ （1,1），（1,0）：将A位置零，指针指向下一位继续查找。





#### 和参考答案对比

除了没有处理出错情况以外，`_fifo_swap_out`函数中，赋值语句放在了删除语句之前，应该不会有对正确性产生影响。