# Lab 8 Report

石景宜 2016011395

## 练习1: 完成读文件操作的实现

### 设计实现过程

`sfs_io_nolock`实际上是完成对文件一个区间读或者写操作的函数。

实际实现过程可以通过以下三个步骤完成：

+ 读头部未对齐区域
  + 若总块数小于一块，则整个区间在一个块的内部，调用`sfs_buf_op`直接读写取块内从`offset%BLKSIZE`开始，长度为`endpos-offset`的一个区域后返回即可。
  + 若总块数不小于一块，则需要读取第一个块内从`offset%BLKSIZE`开始，到块尾的整个区间。
+ 读中间对齐区域：直接调用`sfs_block_op`读取`nblks`个连续块。
+ 读尾部未对齐区域：若尾部未对齐，则需要读写未对齐区域。调用区间读写函数`sfs_buf_op`读写最后一块块内从0开始，长度为endpos%BLKSIZE的区间。

在以上每次读写操作之前，都需要通过`sfs_bmap_load_nolock`得到对应inode号。

通过以上三个步骤和buf/alen的同步增加，文件区间读写操作完成。

### 和参考答案的区别

和参考答案相比，我的实现有如下不同：

+ 我没有在每一次读写后进行错误检查，已经修复。
+ 在中间对齐区间的读写中，我是调用`sfs_bmap_load_nolock`函数直接读写了n个块，而参考答案是循环n次每次读写一个块。考虑了一下，参考答案这种方式应该更容易找到出错位置。

### UNIX 的 PIPE 机制实现设计

在unix系统中，PIPE是进程半双工通信机制，数据只能向一个方向流动，PIPE实际上对应着一段缓冲区，写入的内容放在缓冲区末尾，每次读取从缓冲区头部读取。

##### PIPE的创建

需要创建PIPE时，首先创建一个类型为PIPE的inode并分配用户指定长度的缓冲区，然后新建两个文件结构体和文件描述符，他们的inode均指向之前创建的inode，并分别设置为只读和只写。然后将两个文件描述符返回给用户。

##### PIPE的关闭

检查PIPE上是否有线程被阻塞，若有线程被阻塞，则唤醒并发送读写失败信号。之后释放inode和对应缓冲区。

##### PIPE的读写

PIPE实际是一段有限大小的缓冲区，所以在实现过程中需要维护PIPE现有数据大小和剩余空闲区域大小两个量。以免发生溢出或者读出错。对于写者而言，只要写入量小于剩余区域大小，即可成功写入并返回，否则，进入睡眠状态直到有足够大小的空闲区域。对于读者，只要读取量小于已有数据量，即可成功读取并返回，否则也进入睡眠直到有足够的数据量。

## 练习2：完成基于文件系统的执行程序机制的实现

### 设计实现过程

本练习中，需要加载ELF格式的程序并设置对应虚拟地址、设置用户栈。需要按照注释中提示按步骤实现。

主要实现过程如下：

+ 加载ELF格式程序
  + 建立程序mm。
  + 初始化mm的页目录表。
  + 读取elf_header。
  + 解析elf_header，设置代码段和BSS段虚拟地址，设置标志位。
  + 设置mm可访问地址范围。
  + 读取DATA/TEXT并分配对应页。
  + 读取BSS并分配页，并清0。
+ 设置用户栈
  + 设置用户使用用户栈权限。
  + 在mm中设置用户栈、分配对应页。
  + 设置cr3为当前线程页目录表地址。切换当前线程的mm。
  + 将参数压入栈中。
  + 栈顶按4字节对齐。
  + 将参数指针压入栈中。
  + 将参数个数压入栈中。
  + 设置trapframe。

### 与参考答案对比

基本实现过程和参考答案一致。但是我没有进行错误检测，已经修复。

### UNIX的硬链接和软链接机制

#### 硬链接

+ 创建文件项时将inode号设置为链接对象inode号，inode引用计数增加。
+ 删除文件项时将链接对象inode引用计数减一。

#### 软连接

软连接实际上就是一种文件。

+ 创建时，将inode类型设置为符号链接，文件内容设置为目标路径字符串。
+ 删除时，直接按照普通文件删除方式删除即可。

## 知识点总结

### 实验中涉及到课程中的知识点

+ VFS
+ SFS
+ PIPE
+ 文件描述符
+ inode、打开的文件等结构体
+ 目录
+ inode缓存

### 本次实验没有体现的重要知识点

+ 磁盘缓存和磁盘调度算法
+ 信号、消息队列、共享内存等进程通信机制。
+ RAID
+ 设备IO